---
title: "Analysis"
author: "Kaija Gahm"
date: "11/21/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup
## Load libraries
```{r, echo = FALSE}
source("libraries.R")
source("process_coordinates_funs.R")
```

## Load data
```{r}
load("data/outputs/bursts_allcrops.Rda")
load("data/outputs/allmorpho.Rda")
load("data/outputs/scoords_allcrops.Rda")
```

## Summary stats
### Calculate stats
```{r}
burst_stats <- bursts_allcrops %>% 
  group_by(fullname, trial, crop) %>%
  summarize(avgspeed = mean(speed, na.rm = T),
            maxspeed = max(speed, na.rm = T),
            maxspeedma5 = max(speedma5, na.rm = T)) %>%
  as.data.frame()

burst_info <- bursts_allcrops %>% select(fullname, trial, pond, clutch, indiv, treatment, year, month, day, camera, crop) %>% distinct()

burst_stats <- left_join(burst_stats, burst_info, by = c("fullname", "trial", "crop"))
burst_stats <- burst_stats %>% mutate(tadpole = str_extract(fullname, pattern = "(?<=^).*(?=\\_[[:digit:]]{8}\\_.*$)"))
# The above line doesn't quite work to get the names for the wild tadpoles, so we have to add "Wild" on.
burst_stats$tadpole[burst_stats$treatment == "Wild"] <- paste0(burst_stats$tadpole[burst_stats$treatment == "Wild"], "_Wild")
```

### Add straight line distance from coords
```{r}
coords_stats <- scoords_allcrops %>%
  group_by(fullname, trial, crop) %>%
  filter(row_number() %in% c(1, n())) %>% 
  summarize(xinit = x[1],
            xfin = x[2],
            yinit = y[1],
            yfin = y[2],
            xdiff = xfin-xinit,
            ydiff = yfin-yinit,
            slinedist = sqrt(xdiff^2 + ydiff^2)) %>% select(fullname, trial, crop, slinedist)

burst_stats <- left_join(burst_stats, coords_stats, by = c("fullname", "trial", "crop"))
```

### Save stats
```{r}
save(burst_stats, file = "data/outputs/burst_stats.Rda")
```

## Which time crop to use
"Although a full second was measured for all tadpoles, most showed signs of slowing during the second half second (paired t‐tests comparing first and second half seconds: Bufo: t202 = 12 Scaphiopus t202 = 21, P < 0·001 for both)" (Arendt 2003, Functional Ecology)
### Comparing avgspeed for first and second half seconds
```{r}
test <- burst_stats %>% filter(crop %in% c("First half second", "Second half second"))

# Paired t-test for first and second half seconds, excluding bursts that don't have both.
problems <- test %>% group_by(fullname, trial) %>% summarize(freq = n()) %>% filter(freq < 2) # identify problems

# Remove problems
test <- test %>% filter(!(paste(fullname, trial) %in% paste(problems$fullname, problems$trial))) %>% mutate(unique = paste(fullname, trial)) %>% select(unique, crop, avgspeed)

# Run paired t-test
t.test(avgspeed ~ crop, paired = T, data = test, alternative = "less") # alternative hypothesis that second half sec has a smaller mean than first half sec
```
Interestingly, the t-test does not reveal a significant difference in means. That's odd. 

## Join stats to morpho data
```{r}
stats <- burst_stats %>% select(-c(pond, clutch)) %>% 
  left_join(allmorpho, by = c("tadpole", "treatment")) %>%
         rename(burst_year = "year",
         burst_month = "month",
         burst_day = "day",
         photo_date = "date") %>% select(-c(indiv.y, id, treat))
```

## Exploratory plotting
```{r}
tadpoles <- unique(bursts_allcrops$fullname)
crops <- unique(bursts_allcrops$crop)

bursts_allcrops %>% filter(fullname == tadpoles[100], crop == crops[2]) %>% 
  ggplot(aes(x = frame_burst, y = speedma5, col = factor(trial)))+
  geom_line()+
  xlab("Frame")+
  ylab("Speed (5-frame moving average)")
```

```{r}
head(stats)

# Max speed by pond (excluding high outliers)
stats %>% filter(crop == crops[2], maxspeedma5 < 0.15) %>% ggplot()+
  geom_boxplot(aes(x = factor(pond), y = maxspeedma5))+
  ggtitle("max speedma5 by pond")+
  xlab("Pond")+
  ylab("max speed (moving average), first second")

# Max speed by pond (excluding high outliers)
stats %>% filter(crop == crops[2], avgspeed < 0.1) %>% ggplot()+
  geom_boxplot(aes(x = factor(pond), y = avgspeed))+
  ggtitle("average speed by pond")+
  xlab("Pond")+
  ylab("average speed, first second")

# Visualize speed distributions
stats %>% filter(crop == crops[1]) %>% ggplot(aes(x = maxspeedma5))+
  geom_density(aes(fill = treatment, col = treatment), alpha = 0.3)+
  ggtitle("Max Speed (5-frame moving average)")

stats %>% filter(crop == crops[1]) %>% ggplot(aes(x = avgspeed))+
  geom_density(aes(fill = treatment, col = treatment), alpha = 0.3)+
  ggtitle("First half second average speed")

# Visualize speed distributions without outliers
stats %>% filter(crop == crops[1], maxspeedma5 < 0.2) %>% ggplot(aes(x = maxspeedma5))+
  geom_density(aes(fill = treatment, col = treatment), alpha = 0.3)+
  ggtitle("Max Speed (5-frame moving average)")

stats %>% filter(crop == crops[1], avgspeed < 0.1) %>% ggplot(aes(x = avgspeed))+
  geom_density(aes(fill = treatment, col = treatment), alpha = 0.3)+
  ggtitle("First half second average speed")

```

### Does speed decrease by trial number?
```{r}
stats %>% filter(crop == crops[2], trial < 5, maxspeedma5 < 0.2) %>%
  ggplot(aes(x = jitter(trial), y = maxspeedma5, col = treatment))+
  geom_point()+
  geom_smooth(method = 'lm', formula = y ~ x)+
  ggtitle("Max speed by trial number")+
  ylab("Max speed (moving average)")+
  xlab("Trial number")
```
```{r}
# Model the decrease in speed
tiring_model <- lm(avgspeed ~ trial + treatment, data = stats)
summary(tiring_model)

# There is an effect, but the effect is definitely small.

# Limit it to under 5 trials
tiring_model_under5 <- lm(avgspeed ~ trial + treatment, data = stats[stats$trial < 5,])
summary(tiring_model_under5)

# Less of an effect with fewer trials.
```

### Speed vs. size/shape
#### Speed vs. GS
```{r}
# Speed vs. gosner stage, by treatment
stats %>% filter(!is.na(gs), crop == "First half second", maxspeedma5 < 0.2) %>% 
  ggplot(aes(x = jitter(gs), y = maxspeedma5, col = treatment))+
  facet_wrap(~treatment)+
  geom_point() +
  geom_smooth(method = "lm")
```

#### Speed vs. shape
```{r}
# Speed vs. PC1
stats %>% filter(crop == crops[1], maxspeedma5 < 0.2) %>%
  ggplot(aes(x = PC1, y = maxspeedma5, col = treatment))+
  facet_wrap(~treatment)+
  geom_point()+
  geom_smooth(method = "lm")
# Seems to be very little relationship between speed and PC1

# Speed vs. PC2
stats %>% filter(crop == crops[1], maxspeedma5 < 0.2) %>%
  ggplot(aes(x = PC2, y = maxspeedma5, col = treatment))+
  facet_wrap(~treatment)+
  geom_point()+
  geom_smooth(method = "lm")
# A bit more of an effect for PC2. 
```



