---
title: "Analysis"
author: "Kaija Gahm"
date: "11/21/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup
## Load libraries
```{r, echo = FALSE}
source("libraries.R")
source("process_coordinates_funs.R")
```

## Load data
```{r}
load("data/outputs/bursts_allcrops.Rda")
load("data/outputs/allmorpho.Rda")
load("data/outputs/scoords_allcrops.Rda")
```

## Summary stats
### Calculate stats
```{r}
burst_stats <- bursts_allcrops %>% 
  group_by(fullname, trial, crop) %>%
  summarize(avgspeed = mean(speed, na.rm = T),
            maxspeed = max(speed, na.rm = T),
            maxspeedma5 = max(speedma5, na.rm = T)) %>%
  as.data.frame()

burst_info <- bursts_allcrops %>% select(fullname, trial, pond, clutch, indiv, treatment, year, month, day, camera, crop) %>% distinct()

burst_stats <- left_join(burst_stats, burst_info, by = c("fullname", "trial", "crop"))
burst_stats <- burst_stats %>% mutate(tadpole = str_extract(fullname, pattern = "(?<=^).*(?=\\_[[:digit:]]{8}\\_.*$)"))
# The above line doesn't quite work to get the names for the wild tadpoles, so we have to add "Wild" on.
burst_stats$tadpole[burst_stats$treatment == "Wild"] <- paste0(burst_stats$tadpole[burst_stats$treatment == "Wild"], "_Wild")
```

### Add straight line distance from coords
```{r}
coords_stats <- scoords_allcrops %>%
  group_by(fullname, trial, crop) %>%
  filter(row_number() %in% c(1, n())) %>% 
  summarize(xinit = x[1],
            xfin = x[n()], # note that I use x[n()] instead of x[2] here because there was one burst that didn't have a second row, since it was exactly 31 frames long. This is super rare, but it's worth making the code robust so the second half second speed will show up as 0 and not as NA.
            yinit = y[1],
            yfin = y[n()],
            xdiff = xfin-xinit,
            ydiff = yfin-yinit,
            slinedist = sqrt(xdiff^2 + ydiff^2),
            time = frame_burst[n()]/60,
            sline_speed_m_s = slinedist/time) %>% select(fullname, trial, crop, slinedist, time, sline_speed_m_s)

burst_stats <- left_join(burst_stats, coords_stats, by = c("fullname", "trial", "crop"))

# Sanity check on speeds: We're seeing speeds ranging from 0 to 15 centimeters/sec, which makes sense.
burst_stats %>% ggplot(aes(x = sline_speed_m_s, col = crop, fill = crop))+
  geom_density(alpha = 0.4)
```

### Save stats
```{r}
#save(burst_stats, file = "data/outputs/burst_stats.Rda")
```

## Which time crop to use
"Although a full second was measured for all tadpoles, most showed signs of slowing during the second half second (paired t‐tests comparing first and second half seconds: Bufo: t202 = 12 Scaphiopus t202 = 21, P < 0·001 for both)" (Arendt 2003, Functional Ecology)
### Comparing avgspeed for first and second half seconds
```{r}
test <- burst_stats %>% filter(crop %in% c("First half second", "Second half second"))

# Paired t-test for first and second half seconds, excluding bursts that don't have both.
problems <- test %>% group_by(fullname, trial) %>% summarize(freq = n()) %>% filter(freq < 2) # identify problems

# Remove problems
test <- test %>% filter(!(paste(fullname, trial) %in% paste(problems$fullname, problems$trial))) %>% mutate(unique = paste(fullname, trial)) %>% select(unique, crop, avgspeed, sline_speed_m_s)

# Run paired t-test
t.test(avgspeed ~ crop, paired = T, data = test) # I'm confused about which direction this is going.

# Sanity check
test %>% ggplot(aes(x = avgspeed, col = crop, fill = crop))+
  geom_density(alpha = 0.4)
```
Interestingly, the t-test does not reveal a significant difference in means. That's odd. 

### Comparing avgspeed for first and second half seconds
```{r}
# Run paired t-test
t.test(sline_speed_m_s ~ crop, data = test) # alternative hypothesis that second half sec has a smaller mean than first half sec

# Sanity check
test %>% ggplot(aes(x = sline_speed_m_s, col = crop, fill = crop))+
  geom_density(alpha = 0.4)
```

## First half sec average across trials
```{r}
# By trial run (tadpole x date)
burst_stats_avg_date <- burst_stats %>% filter(crop == "First half second") %>% group_by(fullname) %>%
  summarize(avgavgspeed = mean(avgspeed),
            avgmaxspeed = mean(maxspeed),
            avgmaxspeedma5 = mean(maxspeedma5),
            pond = pond[1],
            clutch = clutch[1],
            indiv = indiv[1],
            treatment = treatment[1],
            year = year[1],
            month = month[1],
            day = day[1],
            camera = camera[1],
            tadpole = tadpole[1],
            avgslinedist = mean(slinedist),
            time = time[1],
            avgslinespeed_ms = mean(sline_speed_m_s)) %>%
  as.data.frame()

# By tadpole
burst_stats_avg_tadpole <- burst_stats %>% filter(crop == "First half second") %>% group_by(tadpole) %>% 
  summarize(avgavgspeed = mean(avgspeed),
            avgmaxspeed = mean(maxspeed),
            avgmaxspeedma5 = mean(maxspeedma5),
            pond = pond[1],
            clutch = clutch[1],
            indiv = indiv[1],
            treatment = treatment[1],
            avgslinedist = mean(slinedist),
            time = time[1],
            avgslinespeed_ms = mean(sline_speed_m_s))
```


## Join stats to morpho data
```{r}
# Cleaning
#First, fix that one space.
burst_stats$fullname[burst_stats$tadpole == "LO_W_09 2_Wild"] <- "LO_W_09_2_20190612_C2"
burst_stats$tadpole[burst_stats$tadpole == "LO_W_09 2_Wild"] <- "LO_W_09_2_Wild"

# Join stats to morpho data
stats <- burst_stats %>% select(-c(pond, clutch)) %>% 
  left_join(allmorpho, by = c("tadpole", "treatment")) %>%
         rename(burst_year = "year",
         burst_month = "month",
         burst_day = "day",
         photo_date = "date") %>% select(-c(indiv.y, id, treat))

locate.nas(stats) # weirdness.
problems <- stats %>% filter(is.na(PC1)) %>% select(tadpole, fullname, trial, crop, treatment) %>% distinct()
problemtadpoles <- unique(problems$tadpole)
problemtadpoles

# Let's deal with the ones that have an extra number at the end. 
multitries <- grep(pattern = "(?<=[[:alpha:]]\\_)[[:digit:]](?=$)", problemtadpoles, perl = T)
alsomulti <- grep(pattern = "(?<=[[:digit:]]{2}\\_)[[:digit:]]\\_(?=Wild$)", problemtadpoles, perl = T)

multitries <- c(multitries, alsomulti)
problemtadpoles[-multitries]

```



## Exploratory plotting
```{r}
tadpoles <- unique(bursts_allcrops$fullname)

bursts_allcrops %>% filter(fullname == tadpoles[100], crop == "First half second") %>% 
  ggplot(aes(x = frame_burst, y = speedma5, col = factor(trial)))+
  geom_line()+
  xlab("Frame")+
  ylab("Speed (5-frame moving average)")
```

```{r}
head(stats)

# Straight line speed by pond (averaging across trials for each tadpole)
burst_stats_avg_tadpole %>% ggplot()+
  geom_violin(aes(x = factor(pond), y = avgslinespeed_ms), fill = "lightblue")+
  ggtitle("Burst speed by pond of origin")+
  xlab("Pond")+
  ylab("Burst speed (m/s)") + theme_minimal()

# Straight line speed by treatment (averaging across trials for each tadpole)
burst_stats_avg_tadpole %>% ggplot()+
  geom_boxplot(aes(x = treatment, y = avgslinespeed_ms, fill = treatment))+
  ggtitle("Burst speed by treatment")+
  xlab("Treatment")+
  ylab("Speed (m/s)")+
  labs(fill = "Temperature \n treatment")

burst_stats_avg_tadpole %>% ggplot()+
  geom_violin(aes(x = treatment, y = avgslinespeed_ms, fill = treatment))+
  ggtitle("Burst speed by treatment")+
  xlab("Treatment")+
  ylab("Speed (m/s)")+
  labs(fill = "Temperature \n treatment")+ theme_minimal()
```


### Does speed decrease by trial number?
```{r}
stats %>% filter(crop == "First half second", trial < 5, sline_speed_m_s < 0.2) %>%
  ggplot(aes(x = jitter(trial), y = sline_speed_m_s, col = treatment))+
  geom_point()+
  geom_smooth(method = 'lm', formula = y ~ x)+
  ggtitle("Straight line speed by trial number")+
  ylab("Straight line speed (first half second)")+
  xlab("Trial number")
```
```{r}
# Model the decrease in speed
tiring_model <- lm(sline_speed_m_s ~ trial + treatment, data = stats)
summary(tiring_model)

# There is an effect, but the effect is definitely small.

# Limit it to under 5 trials
tiring_model_under5 <- lm(sline_speed_m_s ~ trial + treatment, data = stats[stats$trial < 5,])
summary(tiring_model_under5)

# Less of an effect with fewer trials.
```

### Speed vs. size/shape
#### Speed vs. GS
```{r}
# Speed vs. gosner stage, by treatment
stats %>% filter(!is.na(gs), crop == "First half second") %>% 
  ggplot(aes(x = jitter(gs), y = sline_speed_m_s, col = treatment))+
  facet_wrap(~treatment)+
  geom_point() +
  geom_smooth(method = "lm")
```

#### Speed vs. shape
```{r}
# Speed vs. PC1
stats %>% filter(crop == "First half second") %>%
  ggplot(aes(x = PC1, y = sline_speed_m_s, col = treatment))+
  facet_wrap(~treatment)+
  geom_point()+
  geom_smooth(method = "lm")
# Seems to be very little relationship between speed and PC1

# Speed vs. PC2
stats %>% filter(crop == "First half second") %>%
  ggplot(aes(x = PC2, y = sline_speed_m_s, col = treatment))+
  facet_wrap(~treatment)+
  geom_point()+
  geom_smooth(method = "lm")
# A bit more of an effect for PC2. 
```

## Join water temp data
### Load and prep data
```{r}
expdata <- read.csv("data/inputs/Burst_Speed_Data.csv")

expdata <- expdata %>% mutate(Date = as.character(Date),
                              year = 2019,
                              month = as.numeric(substr(Date, 1, 1)),
                              day = as.numeric(str_extract(Date, pattern = "(?<=^[[:digit:]]\\/)[[:digit:]]{1,2}(?=\\/)")),
                              Treatment = capwords(tolower(Treatment)))
expdata <- expdata %>% mutate(tadpole = case_when(Clutch != "W" ~ 
                                                    paste0(Pond, "_0", Clutch, "_", Indiv, "_", Treatment),
                                                  Clutch == "W" &  nchar(as.character(Indiv)) == 1 ~ 
                                                    paste0(Pond, "_W_0", Indiv, "_Wild"),
                                                  Clutch == "W" & nchar(as.character(Indiv)) == 2 ~
                                                    paste0(Pond, "_W_", Indiv, "_Wild")))
```

### Join to burst speed stats
```{r}
expdata_tojoin <- expdata %>% select(T_initial, T_final, tadpole, year, month, day, Cam) %>% mutate(Cam = factor(as.character(Cam))) %>% filter(!is.na(T_initial))

stats_temp <- stats %>% left_join(expdata_tojoin, by = c("tadpole", "burst_year" = "year", "burst_month" = "month", "burst_day" = "day", "camera" = "Cam"))
```

### Investigate problems
```{r}
a <- stats_temp %>% filter(is.na(T_initial)) %>% select(tadpole) %>% unique()
b <- expdata %>% filter(tadpole %in% a) # 0 rows
# let's check manually
```

