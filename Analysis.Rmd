---
title: "Analysis"
author: "Kaija Gahm"
date: "1/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries
```{r, echo = F}
source("libraries.R")
```

# Load data
```{r}
load("data/outputs/stats_fast3.Rda")
```

# Code random effects explicitly
We should have used different letters for the individuals in the two temperature treatments, because strictly speaking we should have labeled the individuals before choosing which ones to put into which temperature treatment. We did select those randomly, but the naming scheme that we chose does not reflect that.

We don't want to change the letters on the tadpoles because that would make the data be out of sync with all of the labels on everything up to this point. Instead, we're going to stick with our scheme of appending "high" or "low" to the names to distinguish e.g. CPS_01_A in high/low treatments (since that is NOT the same individual.)
```{r}
stats_fast3 <- stats_fast3 %>% # remove tadpole column
  mutate(clutch = factor(paste(pond, clutch)), # code clutches explicitly
         indiv = factor(paste(clutch, indiv, treatment))) # code individuals explicitly
locate.nas(stats_fast3)
```

## Select relevant columns and change data types
```{r}
dat3 <- stats_fast3 %>% select(tadpole, trial, indiv, treatment, sline_speed_m_s, PC1, PC2, pond, size, clutch, mass, gs, T_initial) %>% ungroup() %>% mutate(treatment = factor(treatment),
                     pond = factor(pond),
                     clutch = factor(clutch)) %>%
  filter(treatment %in% c("High", "Low"), !is.na(PC1)) %>% droplevels()

# wild tadpoles are separate
wild <- stats_fast3 %>% select(tadpole, trial, treatment, sline_speed_m_s, PC1, PC2, pond, size, mass, gs, T_initial) %>% ungroup() %>% mutate(treatment = factor(treatment),
                     pond = factor(pond)) %>% 
  filter(treatment == "Wild") %>% droplevels()

# fix NA's for pond
wild %>% filter(is.na(pond))
wild$pond[is.na(wild$pond)] <- str_extract(wild$tadpole[is.na(wild$pond)], pattern = "(?<=^)[[:upper:]]{2,3}(?=\\_)")
```

## Export the data for modeling in model_selection.Rmd
```{r}
save(dat3, file = "data/outputs/dat3.Rda")
save(wild, file = "data/outputs/wild.Rda")
```

# Load consensus model
```{r}
load("data/outputs/consensus_mod.Rda")
```

# ICCC 
## Calculate ICCC

### Manual calculation of residuals
#### Retaining the individual speeds and comparing them to different things
```{r}
overall <- dat3 %>% select(treatment, pond, clutch, tadpole, trial, sline_speed_m_s) %>% 
  group_by(treatment) %>%
  mutate(mean = mean(sline_speed_m_s),
                resid = sline_speed_m_s - mean) %>%
  mutate(level = "overall")

indiv <- overall %>% group_by(treatment, tadpole) %>% 
  mutate(mean = mean(sline_speed_m_s),
         resid = sline_speed_m_s - mean) %>%
  mutate(level = "indiv")

clutch <- overall %>% group_by(treatment, clutch) %>%
  mutate(mean = mean(sline_speed_m_s),
         resid = sline_speed_m_s - mean) %>%
  mutate(level = "clutch")

pond <- overall %>% group_by(treatment, pond) %>%
  mutate(mean = mean(sline_speed_m_s),
         resid = sline_speed_m_s - mean) %>%
  mutate(level = "pond")

wild_overall <- wild %>% select(treatment, pond, tadpole, trial, sline_speed_m_s) %>%
  group_by(treatment) %>%
  mutate(mean = mean(sline_speed_m_s),
         resid = sline_speed_m_s - mean) %>%
  mutate(level = "overall")

wild_indiv <- wild_overall %>% group_by(treatment, tadpole) %>%
  mutate(mean = mean(sline_speed_m_s),
         resid = sline_speed_m_s - mean) %>%
  mutate(level = "indiv")

wild_pond <- wild_overall %>% group_by(treatment, pond) %>%
  mutate(mean = mean(sline_speed_m_s),
         resid = sline_speed_m_s - mean) %>%
  mutate(level = "pond")

resids <- rbind(overall, indiv, clutch, pond, wild_overall, wild_indiv, wild_pond) # put them all together

resids$level <- factor(resids$level, levels = c("overall", "pond", "clutch", "indiv"))

# Density plot
resids %>% ggplot(aes(x = resid, col = treatment, fill = treatment))+
  geom_density(alpha = 0.4, adjust = 2)+
  facet_grid(rows = vars(level), cols = vars(treatment))

# Ridge plot
resids %>% ggplot(aes(x = resid, fill = level))+
  geom_density_ridges(aes(y = level),
                      scale = 3)+
                      #bandwidth = 0.006)+
  facet_wrap(~treatment)+
  scale_y_discrete(expand = expand_scale(mult = c(0.01, 0.8)))+
  theme(legend.position = "none")

# get just the variance of the resids
var_resids <- resids %>% 
  group_by(treatment, level) %>%
  summarize(var = var(resid)) %>% ungroup

var_resids <- rbind(var_resids, c("Wild", "clutch", NA)) %>% mutate(var = as.numeric(var))

# Line plot
var_resids %>% ggplot(aes(x = level, y = var, col = treatment, group = treatment))+
  geom_line()+
  geom_point(data = var_resids %>% filter(treatment == "Wild", level == "indiv"))
``` 

#### Retaining the individual speeds and comparing them to different things
```{r}
overallsmall <- overall %>% select(treatment, mean, resid, level)

indivsmall <- indiv %>% select(treatment, mean, resid, level)

clutch <- indiv %>% 
  select(treatment, pond, clutch, tadpole, mean) %>% 
  distinct() %>% # get rid of multiple trials
  rename(indiv_mean = mean) %>%
  group_by(treatment, clutch) %>%
  mutate(clutch_mean = mean(indiv_mean),
         resid = indiv_mean - clutch_mean) %>%
  select(-c(indiv_mean, tadpole)) %>%
  rename(mean = clutch_mean) %>% ungroup() %>%
  mutate(level = "clutch")
clutchsmall <- clutch %>% select(treatment, mean, resid, level)

pond <- clutch %>% select(-resid) %>%
  distinct() %>%
  rename(clutch_mean = mean) %>%
  group_by(treatment, pond) %>%
  mutate(pond_mean = mean(clutch_mean),
         resid = clutch_mean - pond_mean) %>%
  select(-c(clutch_mean, clutch)) %>%
  rename(mean = pond_mean) %>% ungroup() %>%
  mutate(level = "pond")
pondsmall <- pond %>% select(treatment, mean, resid, level)

wild_overallsmall <- wild_overall %>% select(treatment, mean, resid, level)

wild_indiv <- wild_overall %>% select(treatment, pond, tadpole, sline_speed_m_s) %>%
  group_by(tadpole) %>% 
  mutate(indiv_mean = mean(sline_speed_m_s),
         resid = sline_speed_m_s - indiv_mean) %>%
  rename(mean = indiv_mean) %>% ungroup() %>%
  mutate(level = "indiv")
wild_indivsmall <- wild_indiv %>% select(treatment, mean, resid, level)

wild_pond <- wild_indiv %>% select(-resid) %>%
  distinct() %>%
  rename(indiv_mean = mean) %>%
  group_by(treatment, pond) %>%
  mutate(pond_mean = mean(indiv_mean),
         resid = indiv_mean - pond_mean) %>%
  select(-c(indiv_mean)) %>%
  rename(mean = pond_mean) %>% ungroup() %>%
  mutate(level = "pond")
wild_pondsmall <- wild_pond %>% select(treatment, mean, resid, level)

resids_cumulative <- bind_rows(overallsmall, indivsmall, clutchsmall, pondsmall, wild_overallsmall, wild_indivsmall, wild_pondsmall)
resids_cumulative$level <- factor(resids_cumulative$level, levels = c("overall", "pond", "clutch", "indiv"))

# Density plot
resids_cumulative %>% ggplot(aes(x = resid, col = treatment, fill = treatment))+
  geom_density(alpha = 0.4, adjust = 2)+
  facet_grid(rows = vars(level), cols = vars(treatment))

# Ridge plot
resids_cumulative %>% ggplot(aes(x = resid, fill = level))+
  geom_density_ridges(aes(y = level),
                      scale = 3,
                      bandwidth = 0.006)+
  facet_wrap(~treatment)+
  scale_y_discrete(expand = expand_scale(mult = c(0.01, 0.8)))+
  theme(legend.position = "none")

# get just the variance of the resids
var_resids_cumulative <- resids_cumulative %>% 
  group_by(treatment, level) %>%
  summarize(var = var(resid)) %>% ungroup

var_resids_cumulative <- rbind(var_resids_cumulative, c("Wild", "clutch", NA)) %>% mutate(var = as.numeric(var))

# Line plot
var_resids_cumulative %>% ggplot(aes(x = level, y = var, col = treatment, group = treatment))+
  geom_line()+
  geom_point(data = var_resids_cumulative %>% filter(treatment == "Wild", level == "indiv"))
```

```{r}
load("data/outputs/consensus_mod.Rda")
sds <- summary(consensus_mod)$varcor %>% as.data.frame()

indiv_variance <- sds$vcov[sds$grp == "indiv:clutch"]
clutch_variance <- sds$vcov[sds$grp == "clutch"]
resid_variance <- sds$vcov[sds$grp == "Residual"]

tot_rand_variance <- indiv_variance + clutch_variance + resid_variance
iccc_indiv <- indiv_variance/tot_rand_variance
iccc_clutch <- clutch_variance/tot_rand_variance

iccc_indiv # individual-level variance is a much larger component than clutch-level variance.
iccc_clutch
```

## Bootstrap CI's for ICCC
```{r}
calc_iccc_indiv <- function(model){
  mod_smy <- summary(model) # get the model summary
  df <- mod_smy$varcor %>% as.data.frame() # extract info about the random variables
  random_var <- sum(df$vcov) # total random variance
  iccc <- df$vcov[1]/random_var # variance of the chosen variable divided by total random variance
}

calc_iccc_clutch <- function(model){
  mod_smy <- summary(model) # get the model summary
  df <- mod_smy$varcor %>% as.data.frame() # extract info about the random variables
  random_var <- sum(df$vcov) # total random variance
  iccc <- df$vcov[2]/random_var # variance of the chosen variable divided by total random variance
}

calc_iccc_resid <- function(model){
  mod_smy <- summary(model) # get the model summary
  df <- mod_smy$varcor %>% as.data.frame() # extract info about the random variables
  random_var <- sum(df$vcov) # total random variance
  iccc <- df$vcov[3]/random_var # variance of the chosen variable divided by total random variance
}

# Bootstrapping for individual iccc
boot_iccc_indiv <- bootMer(consensus_mod, calc_iccc_indiv, nsim = 1000, .progress = "txt")
boot_iccc_clutch <- bootMer(consensus_mod, calc_iccc_clutch, nsim = 1000, .progress = "txt")
boot_iccc_resid <- bootMer(consensus_mod, calc_iccc_resid, nsim = 1000, .progress = "txt")

iccc_indiv_vec <- boot_iccc_indiv$t
iccc_clutch_vec <- boot_iccc_clutch$t
iccc_resid_vec <- boot_iccc_resid$t

# Make a data frame for visualization
iccc <- data.frame(level = c(rep("clutch", 1000), rep("indiv", 1000), rep("resid", 1000)),
                   iccc_estimate = c(iccc_clutch_vec, iccc_indiv_vec, iccc_resid_vec))
```
Look back into literature: ICCC paper. 




## Visualize 
```{r}
iccc %>% ggplot(aes(x = level, y = iccc_estimate))+
  theme_minimal()+
  geom_boxplot()+
  ylab("ICCC")+
  xlab("Random variable")
```

# Plasticity
## Differences in means
### Individual means
```{r}
indiv_means <- dat3_nonas %>% group_by(indiv) %>% 
  summarize(indiv_mean_speed = mean(sline_speed_m_s),
            clutch = clutch[1],
            treatment = treatment[1],
            pond = pond[1]) 

head(indiv_means)
```

### Clutch means
```{r}
clutch_means <- indiv_means %>% 
  group_by(clutch, treatment) %>% 
  summarize(clutch_mean_speed = mean(indiv_mean_speed))

clutch_means %>% arrange(clutch)
clutch_means %$% table(clutch) #ADD THIS TO THE TUTORIAL!!!
```

#### Remove clutches not in both treatments
```{r}
clutch_means <- clutch_means %>% 
  group_by(clutch) %>%
  mutate(freq = n()) %>%
  ungroup() %>%
  filter(freq == 2) %>%
  select(-freq)

# We actually only removed CPS 1, which didn't occur in the Low treatment (probably because they all died?)
```

###Treatment differences
```{r}
treatment_diffs <- clutch_means %>%
  group_by(clutch) %>%
  summarize(diff = clutch_mean_speed[treatment == "Low"] - clutch_mean_speed[treatment == "High"])

treatment_diffs %>% ggplot(aes(x = diff))+
  geom_histogram()
```
What I've calculated here is D, the "scope of plastic response" (Stearns 1992, cited in Valladares _et al._ 2006): mean at low resource availability - mean at high resource availability. (note low vs. high is switched from the paper because in this case high temp ~ slower speed.)

## Individuals vs. means
### Opposite treatment means
```{r}
clutch_means <- clutch_means %>%
  group_by(clutch) %>%
  mutate(opposite_clutch_mean = case_when(treatment == "High" ~ clutch_mean_speed[treatment == "Low"],
                                   treatment == "Low" ~ clutch_mean_speed[treatment == "High"]))

head(clutch_means)
```

### Join to individual means
```{r}
indiv_means <- indiv_means %>%
  left_join(clutch_means, by = c("treatment", "clutch"))

head(indiv_means)
```

### Indiv/opp clutch differences
If we always subtract individual - mean, or always mean - individual, the distribution will be centered around 0 because we'll be subtracting a mixture of high-low and low-high. Need to be consistent with temperatures, which means inconsistent with direction of subtraction.

We're going to default to always subtracting low - high. 
```{r}
indiv_means <- indiv_means %>%
  mutate(indiv_opp_clutch_diff = case_when(treatment == "High" ~ opposite_clutch_mean - indiv_mean_speed,
                                           treatment == "Low" ~ indiv_mean_speed - opposite_clutch_mean))
```

### Simplify data
```{r}
plasticity <- indiv_means %>% select(-c(clutch_mean_speed)) %>% rename(D = indiv_opp_clutch_diff)
```

### Fit model predicting difference by pond
```{r}
head(plasticity)
plasticity <- plasticity %>% mutate(clutch_only = factor(str_extract(clutch, pattern = "(?<= )[[:digit:]](?=$)")))

pls_mod <- lmer(D ~ pond + (1|clutch), data = plasticity)
summary(pls_mod)

plot(pls_mod) # plot residuals: they look good.

# Plot effect sizes
sjPlot::plot_model(pls_mod, type = "eff")

# Plot all D points
plasticity %>% ggplot(aes(x = pond, y = D))+
  geom_violin()+
  geom_jitter(aes(col = clutch_only), width = 0.1)+
  scale_color_viridis(discrete = T) # no patterns by pond _or_ clutch within pond. Yikes!
```



# Morphology vs. Burst Speed
Does morphology help to explain burst speed? And does this relationship hold in wild populations?

## Wild tadpoles
### Clean wild data
```{r}
head(wild)
wild_nonas <- wild[complete.cases(wild),] # remove NA's
```

### Explore wild data
```{r}
# Any differences by pond?
wild_nonas %>% ggplot(aes(x = mass, y = sline_speed_m_s, col = T_initial))+
  geom_smooth(method = "lm", col = "gray", se = F)+
  geom_point()+
  facet_wrap(~pond)+
  scale_color_viridis()

# Size
wild_nonas %>% 
  ggplot(aes(x = size, y = sline_speed_m_s))+
  geom_smooth(aes(col = pond), method = "lm", se = F)+
  geom_smooth(method = "lm", se = F, col = "darkgrey", lty = 2)+
  geom_point(aes(col = pond))+
  scale_color_viridis(discrete = TRUE)

# Gosner stage
wild_nonas %>% 
  ggplot(aes(x = gs, y = sline_speed_m_s))+
  geom_smooth(aes(col = pond), method = "lm", se = F)+
  geom_smooth(method = "lm", se = F, col = "darkgrey", lty = 2)+
  geom_point(aes(col = pond))+
  scale_color_viridis(discrete = TRUE)

# Mass
wild_nonas %>% 
  ggplot(aes(x = mass, y = sline_speed_m_s))+
  geom_smooth(aes(col = pond), method = "lm", se = F)+
  geom_smooth(method = "lm", se = F, col = "darkgrey", lty = 2)+
  geom_point(aes(col = pond))+
  scale_color_viridis(discrete = TRUE)

# Shape PC1
wild_nonas %>% 
  ggplot(aes(x = PC1, y = sline_speed_m_s))+
  geom_smooth(aes(col = pond), method = "lm", se = F)+
  geom_smooth(method = "lm", se = F, col = "darkgrey", lty = 2)+
  geom_point(aes(col = pond))+
  scale_color_viridis(discrete = TRUE)

# Shape PC2
wild_nonas %>% 
  ggplot(aes(x = PC2, y = sline_speed_m_s))+
  geom_smooth(aes(col = pond), method = "lm", se = F)+
  geom_smooth(method = "lm", se = F, col = "darkgrey", lty = 2)+
  geom_point(aes(col = pond))+
  scale_color_viridis(discrete = TRUE)

wild_nonas %>% ggplot(aes(x = pond, y = sline_speed_m_s))+
  geom_violin()
```

### Make same model as for lab tadpoles
```{r}
load("data/outputs/consensus_mod.Rda")
formula(consensus_mod)
wild_mod <- lmer(sline_speed_m_s ~ mass + gs + T_initial + (1 | tadpole), data = wild_nonas, REML = F,
                 na.action = "na.fail")
summary(wild_mod)
```

